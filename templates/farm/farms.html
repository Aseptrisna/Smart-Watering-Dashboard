<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Lahan - Smart Watering</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

    <style>
        :root {
            --bg-main: #f8f9fa;
            --bg-card: #ffffff;
            --color-primary: #1E463F;
            --color-text: #212529;
            --color-muted: #6c757d;
            --border-color: #dee2e6;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-main);
            color: var(--color-text);
        }
        .wrapper { display: flex; }
        .main-wrapper { flex-grow: 1; }
        .content-area { padding: 2rem; }
        .sidebar {
            width: 260px;
            background-color: var(--bg-card);
            min-height: 100vh;
            border-right: 1px solid var(--border-color);
            transition: margin-left 0.3s ease;
        }
        .sidebar-brand { color: var(--color-text) !important; }
        .sidebar .nav-link {
            color: var(--color-text);
            font-weight: 500;
            padding: 0.85rem 1.5rem;
            margin: 0.25rem 1rem;
            border-radius: 0.5rem;
        }
        .sidebar .nav-link i { margin-right: 1rem; }
        .sidebar .nav-link:hover { color: var(--color-primary); }
        .sidebar .nav-link.active {
            background-color: var(--color-primary);
            color: var(--bg-card);
        }
        .card {
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.03);
            background-color: var(--bg-card);
        }
        .btn-primary {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .btn-primary:hover {
            background-color: #14302A;
            border-color: #14302A;
        }
        .farm-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .farm-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.07); }
        .farm-card-img-container { height: 180px; overflow: hidden; position: relative; }
        .farm-card-img-container img { width: 100%; height: 100%; object-fit: cover; }
        #farms-map { border-radius: 0.75rem; }

        .bottom-nav { display: none; }
        @media (max-width: 991.98px) {
            .wrapper { display: block; }
            .sidebar { position: fixed; z-index: 1050; margin-left: -260px; }
            .sidebar.active { margin-left: 0; }
            .content-area { padding: 1.5rem 1rem; }
            body { padding-bottom: 80px; }
            .bottom-nav {
                display: flex; position: fixed; bottom: 0; left: 0; right: 0;
                height: 65px; background-color: var(--bg-card);
                border-top: 1px solid var(--border-color);
                justify-content: space-around; align-items: center; z-index: 1000;
            }
            .bottom-nav-item {
                display: flex; flex-direction: column; align-items: center;
                text-decoration: none; color: var(--color-muted); font-size: 0.7rem;
            }
            .bottom-nav-item i { font-size: 1.5rem; }
            .bottom-nav-item.active { color: var(--color-primary); }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <aside class="sidebar">
        <div class="sidebar-header text-center py-4">
            <a href="{{ url_for('home') }}" class="h5 fw-bold text-decoration-none">
                <i class="bi bi-droplet-half me-2" style="color: var(--color-primary);"></i>SmartWatering
            </a>
        </div>
        <ul class="nav flex-column sidebar-nav">
            <li class="nav-item"><a href="{{ url_for('home') }}" class="nav-link"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
            <li class="nav-item"><a href="{{ url_for('farms') }}" class="nav-link active"><i class="bi bi-map"></i> <span>Lahan Saya</span></a></li>
            <li class="nav-item"><a href="{{ url_for('devices') }}" class="nav-link"><i class="bi bi-cpu"></i> <span>Perangkat</span></a></li>
            <li class="nav-item"><a href="{{ url_for('schedules') }}" class="nav-link"><i class="bi bi-calendar4-week"></i> <span>Jadwal</span></a></li>
            <li class="nav-item"><a href="{{ url_for('history') }}" class="nav-link"><i class="bi bi-clock-history"></i> <span>Riwayat</span></a></li>
        </ul>
    </aside>

    <div class="main-wrapper">
        <main class="content-area">
            <div class="container-fluid">
                <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-4">
                    <h1 class="h3 fw-bold mb-0">Manajemen Lahan</h1>
                    <a href="{{ url_for('add_farm') }}" class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Tambah Lahan
                    </a>
                </div>

                {% if farms %}
                <div class="card mb-4">
                    <div class="card-body">
                         <div class="input-group">
                            <span class="input-group-text border-0 bg-light"><i class="bi bi-search"></i></span>
                            <input type="text" id="farmSearchInput" class="form-control border-0 bg-light" placeholder="Cari lahan berdasarkan nama, lokasi, atau tanaman...">
                        </div>
                    </div>
                </div>

                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="pills-cards-tab" data-bs-toggle="pill" data-bs-target="#pills-cards" type="button" role="tab"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Tampilan Kartu</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pills-table-tab" data-bs-toggle="pill" data-bs-target="#pills-table" type="button" role="tab"><i class="bi bi-table me-2"></i>Tampilan Tabel</button>
                    </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-cards" role="tabpanel">
                        <div class="row" id="farm-list-cards">
                            {% for farm in farms %}
                            <div class="col-md-6 col-xl-4 mb-4 farm-card-wrapper" data-name="{{ farm.name|lower }}" data-location="{{ farm.location|lower }}" data-crop="{{ farm.crop_type|lower }}">
                                <div class="card h-100 farm-card">
                                    {% set image_map = {'Jagung': 'corn.jpg', 'Padi': 'rice.jpg', 'Tomat': 'tomatoes.jpg', 'Cabai': 'chili.jpg'} %}
                                    {% set farm_image = image_map.get(farm.crop_type, 'default_farm.jpg') %}
                                    <!-- <div class="farm-card-img-container">
                                        <img src="{{ url_for('static', filename='images/farms/' ~ farm_image) }}" class="card-img-top" alt="{{ farm.crop_type }}">
                                    </div> -->
                                    <div class="card-body d-flex flex-column">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h5 class="card-title fw-bold mb-1">{{ farm.name }}</h5>
                                            <div class="dropdown">
                                                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown"><i class="bi bi-three-dots-vertical"></i></button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" href="{{ url_for('farm_detail', farm_id=farm._id) }}"><i class="bi bi-info-circle me-2"></i>Detail</a></li>
                                                    <li><a class="dropdown-item" href="{{ url_for('edit_farm', farm_id=farm._id) }}"><i class="bi bi-pencil me-2"></i>Edit</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="{{ url_for('delete_farm', farm_id=farm._id) }}" onclick="return confirm('Yakin ingin menghapus lahan ini?')"><i class="bi bi-trash me-2"></i>Hapus</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                        <p class="card-text text-muted small mb-3"><i class="bi bi-geo-alt me-1"></i>{{ farm.location }}</p>
                                        <div class="mt-auto border-top pt-3 d-flex justify-content-between text-center">
                                            <div><i class="bi bi-bounding-box-circles d-block text-muted"></i><span class="fw-bold">{{ farm.area }}</span> <small>m²</small></div>
                                            <div><i class="bi bi-flower1 d-block text-muted"></i><span class="fw-bold">{{ farm.crop_type }}</span></div>
                                            <div><i class="bi bi-cpu d-block text-muted"></i><span class="fw-bold">{{ farm.devices_count | default(0) }}</span> <small>Alat</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="tab-pane fade" id="pills-table" role="tabpanel">
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Nama Lahan</th>
                                            <th>Lokasi</th>
                                            <th>Tanaman</th>
                                            <th class="text-center">Luas (m²)</th>
                                            <th class="text-center">Perangkat</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="farm-list-table">
                                        {% for farm in farms %}
                                        <tr class="farm-table-row" data-name="{{ farm.name|lower }}" data-location="{{ farm.location|lower }}" data-crop="{{ farm.crop_type|lower }}">
                                            <td><strong>{{ farm.name }}</strong></td>
                                            <td>{{ farm.location }}</td>
                                            <td><span class="badge bg-secondary-subtle text-secondary-emphasis">{{ farm.crop_type }}</span></td>
                                            <td class="text-center">{{ farm.area }}</td>
                                            <td class="text-center">{{ farm.devices_count | default(0) }}</td>
                                            <td class="text-end">
                                                <a href="{{ url_for('farm_detail', farm_id=farm._id) }}" class="btn btn-sm btn-outline-primary">Detail</a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-white"><h5 class="card-title fw-bold mb-0"><i class="bi bi-map-fill me-2"></i>Peta Lokasi Lahan</h5></div>
                    <div class="card-body p-0"><div id="farms-map" style="height: 450px; width: 100%;"></div></div>
                </div>
                
                {% else %}
                <div class="card text-center py-5">
                    <div class="card-body">
                        <i class="bi bi-compass display-4 text-muted mb-3"></i>
                        <h4 class="card-title">Anda Belum Memiliki Lahan</h4>
                        <p class="text-muted">Mari mulai dengan menambahkan lahan pertama Anda untuk dikelola.</p>
                        <a href="{{ url_for('add_farm') }}" class="btn btn-primary mt-3"><i class="bi bi-plus-circle me-2"></i>Tambah Lahan Pertama Anda</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<nav class="bottom-nav">
    <a href="{{ url_for('home') }}" class="bottom-nav-item"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
    <a href="{{ url_for('farms') }}" class="bottom-nav-item active"><i class="bi bi-map-fill"></i><span>Lahan</span></a>
    <a href="{{ url_for('devices') }}" class="bottom-nav-item"><i class="bi bi-cpu"></i><span>Perangkat</span></a>
    <a href="{{ url_for('profile') }}" class="bottom-nav-item"><i class="bi bi-person"></i><span>Profil</span></a>
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inisialisasi Peta jika ada data lahan
    {% if farms %}
    const farmsData = [
        {% for farm in farms %}{ lat: {{ farm.latitude }}, lng: {{ farm.longitude }}, name: "{{ farm.name | e }}", location: "{{ farm.location | e }}", url: "{{ url_for('farm_detail', farm_id=farm._id) }}" },{% endfor %}
    ];
    if (farmsData.length > 0) {
        const map = L.map('farms-map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
        const markers = farmsData.map(farm => L.marker([farm.lat, farm.lng]).bindPopup(`<b>${farm.name}</b><br>${farm.location}<br><a href='${farm.url}'>Lihat Detail</a>`));
        const group = L.featureGroup(markers).addTo(map);
        map.fitBounds(group.getBounds().pad(0.2));
    }
    {% endif %}

    // Skrip Pencarian Real-time untuk kedua tampilan
    const searchInput = document.getElementById('farmSearchInput');
    if (searchInput) {
        const farmCardWrappers = document.querySelectorAll('.farm-card-wrapper');
        const farmTableRows = document.querySelectorAll('.farm-table-row');
        
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            farmCardWrappers.forEach(card => {
                const name = card.dataset.name || '';
                const location = card.dataset.location || '';
                const crop = card.dataset.crop || '';
                card.style.display = (name.includes(searchTerm) || location.includes(searchTerm) || crop.includes(searchTerm)) ? '' : 'none';
            });

            farmTableRows.forEach(row => {
                const name = row.dataset.name || '';
                const location = row.dataset.location || '';
                const crop = row.dataset.crop || '';
                row.style.display = (name.includes(searchTerm) || location.includes(searchTerm) || crop.includes(searchTerm)) ? '' : 'none';
            });
        });
    }
});
</script>
</body>
</html>